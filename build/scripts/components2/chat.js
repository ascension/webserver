define(["lib/react","lib/clib"],function(e,t){function i(e,t){var r=this,i;switch(e.type){case"say":switch(e.role){case"admin":i="msg-admin-message";break;case"moderator":i="msg-moderator-message";break;case"user":default:i="msg-chat-message"}var s=r.props.engine.username;return s&&e.username!=s&&e.message.toLowerCase().indexOf(s.toLowerCase())!=-1&&(i+=" msg-highlight-message"),n.li({className:i,key:"msg"+t},n.a({href:"/user/"+e.username,target:"_blank"},e.username,":")," ",e.message);case"mute":return i="msg-mute-message",n.li({className:i,key:"msg"+t},n.a({href:"/user/"+e.moderator,target:"_blank"},"*** <"+e.moderator+">"),e.shadow?" shadow muted ":" muted ",n.a({href:"/user/"+e.username,target:"_blank"},"<"+e.username+">")," for "+e.timespec);case"error":case"info":return i="msg-info-message",n.li({className:i,key:"msg"+t},n.span(null," *** "+e.message));default:}}var n=e.DOM,r=120;return e.createClass({displayName:"Chat",propTypes:{engine:e.PropTypes.object.isRequired},getInitialState:function(){return this.listLength=this.props.engine.chat.length,{}},copyGameInfo:function(e){return function(){window.prompt("Copy to clipboard: Ctrl+C, Enter","ID: "+e.game_id+"\n Hash: "+e.hash+"\n Seed hash: "+e.seed_hash)}},render:function(){var e=this,t=this.props.engine.chat.map(i,e),r;return this.props.engine.username?r=n.input({className:"chat-input",onKeyDown:this.sendMessage,ref:"input",placeholder:"Type here..."}):r=n.input({className:"chat-input",onKeyDown:this.sendMessage,ref:"input",placeholder:"Log in to chat...",disabled:!0}),n.div({className:"messages-container"},n.ul({className:"messages",ref:"messages"},t),r)},sendMessage:function(e){if(e.keyCode==13){var t=this.refs.input.getDOMNode().value;t.length>1&&t.length<500&&(this.props.engine.say(t,function(e){console.log("Error sending message",e)}),this.refs.input.getDOMNode().value="")}},shouldComponentUpdate:function(e,t){return e.engine.chat.length!=this.listLength?(this.listLength=e.engine.chat.length,!0):!1},componentDidUpdate:function(){var e=this.refs.messages.getDOMNode(),t=e.scrollHeight-e.offsetHeight-e.scrollTop;t<r&&(e.scrollTop=e.scrollHeight)},componentDidMount:function(){var e=this.refs.messages.getDOMNode();e.scrollTop=e.scrollHeight}})});